swagger: '2.0'
info:
  title: Backend API
  version: '1'
schemes:
  - https
consumes:
  - application/json
produces:
  - application/json

paths:
  /:
    get:
      summary: Retrieve the API spec
      description: Returns the current specification of this API.
      security:
        - member_token: []
      tags:
        - Spec
      responses:
        200:
          $ref: '#/responses/Api'
        default:
          $ref: '#/responses/Error'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetApi.Arn}/invocations
  /weblogin:
    get:
      summary: Set website cookies
      description: Sets browser cookies for accessing protected content on the website.
      security:
        - member_token: []
      tags:
        - Web
      responses:
        200:
          $ref: '#/responses/Cookies'
        default:
          $ref: '#/responses/Error'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GenerateSignedCookies.Arn}/invocations
  /projects:
    get:
      summary: Search projects
      description: |
        Returns a list of projects for the current member,
        filtered by optional parameters.

        **requires scopes:
        *projects:describe*,
        *projects:describe_details (conditional)*
        **
      security:
        - member_token: []
      tags:
        - Projects
      parameters:
        - $ref: '#/parameters/ProjectsQueryNameContains'
        - $ref: '#/parameters/ProjectsQueryIsMember'
        - $ref: '#/parameters/ProjectsQueryIsHidden'
        - $ref: '#/parameters/ProjectsQueryStatus'
        - $ref: '#/parameters/ProjectsQueryIRB'
        - $ref: '#/parameters/QueryPaginationFrom'
        - $ref: '#/parameters/QueryPaginationMax'
      responses:
        200:
          $ref: '#/responses/ListOfProjects'
        default:
          $ref: '#/responses/Error'
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetProjects.Arn}/invocations

definitions:
  Project:
    required:
      - id
      - name
      - status
    properties:
      id:
        $ref: '#/definitions/ProjectId'
      name:
        $ref: '#/definitions/ProjectName'
      hidden:
        $ref: '#/definitions/ProjectHidden'
      status:
        $ref: '#/definitions/ProjectStatus'
      IRB:
        $ref: '#/definitions/ProjectIRB'
  ProjectId:
    description: Unique identifier for a project
    type: string
    format: uuid
  ProjectName:
    description: Project name
    type: string
    pattern: ^[\w-., ]{1,100}$
  ProjectHidden:
    description:
      Indicates whether project name and status are hidden from public view
    type: boolean
  ProjectStatus:
    description: Project status
    type: string
    enum:
      - Available
      - Removed
  ProjectIRB:
    description: project IRB identifier
    type: string
    pattern: ^[\w-.]{1,100}$
  ListOfProjects:
    type: object
    properties:
      projects:
        type: array
        items:
          $ref: '#/definitions/Project'
      next:
        $ref: '#/definitions/PaginationNext'
  PaginationNext:
    type: integer
    minimum: 1
  Error:
    properties:
      message:
        type: string

parameters:
  ProjectsQueryNameContains:
    in: query
    name: name_contains
    description: part of project name, case-insensitive
    type: string
    pattern: ^[\w-., ]{1,100}$
  ProjectsQueryIsMember:
    in: query
    name: is_member
    description: filter projects by requester's membership
    type: boolean
  ProjectsQueryIsHidden:
    in: query
    name: is_hidden
    description: |
      filter by project 'hidden' flag

      **requires scope:
      *projects:describe_details*
      **
    type: boolean
  ProjectsQueryStatus:
    in: query
    name: status
    description: filter by project status
    type: string
    enum:
      - Available
      - Removed
  ProjectsQueryIRB:
    in: query
    name: irb
    description: |
      project IRB (might not be unique)

      **requires scope:
      *projects:describe_details*
      **
    type: string
    pattern: ^[\w-.]{1,100}$
  QueryPaginationFrom:
    in: query
    name: from
    description: starting index for pagination
    type: integer
    minimum: 0
    default: 0
  QueryPaginationMax:
    in: query
    name: max
    description: maximum count of paginated results
    type: integer
    minimum: 1
    default: 10

responses:
  Api:
    description: OpenAPI/Swagger 2.0 definition of this API.
    schema:
      type: object
  Cookies:
    description: Set-Cookie headers for accessing the website
    headers:
      Set-Cookie:
        description: '"CloudFront-Expires" header'
        type: string
      Set-cookie:
        description: '"CloudFront-Key-Pair-Id" header'
        type: string
      set-cookie:
        description: '"CloudFront-Signature" header'
        type: string
  ListOfProjects:
    description: List of projects
    schema:
      $ref: '#/definitions/ListOfProjects'
  Error:
    description: Error response
    schema:
      properties:
        message:
          type: string
        errors:
          type: array
          items:
            $ref: '#/definitions/Error'

securityDefinitions:
  member_token:
    type: apiKey
    in: header
    name: Authorization
    x-amazon-apigateway-authtype: custom
    x-amazon-apigateway-authorizer:
      type: token
      authorizerUri:
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Authorizer.Arn}/invocations
      authorizerCredentials:
        Fn::Sub: ${AuthorizerInvocationRole.Arn}
      identityValidationExpression: '^[\w-]{100,200}\.[\w-]{200,400}\.[\w-]{300,600}$'
      authorizerResultTtlInSeconds: 60
